version: '3.8'

# VPS Deployment - Cloud Command Center
# This runs on Vultr VPS as the central orchestration layer
# srv01 (simulation) connects TO this control plane

services:
  # rosbridge - WebSocket bridge between ROS2 and web clients
  rosbridge:
    image: ros:humble
    container_name: rosbridge_vps
    network_mode: "host"
    restart: unless-stopped
    command: >
      bash -c "
        source /opt/ros/humble/setup.bash &&
        apt-get update && apt-get install -y ros-humble-rosbridge-suite &&
        ros2 launch rosbridge_server rosbridge_websocket_launch.xml
      "
    environment:
      - ROS_DOMAIN_ID=0
      - FASTRTPS_DEFAULT_PROFILES_FILE=/root/fastdds_config.xml
    volumes:
      - ../../fastdds_config.xml:/root/fastdds_config.xml:ro

  # frontend - React web UI (fleet dashboard)
  frontend:
    build:
      context: ../../web_interface/frontend
      dockerfile: ../../docker/dev/frontend.dev.Dockerfile
    container_name: frontend_vps
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ../../web_interface/frontend:/app
      - /app/node_modules
    environment:
      - VITE_ROSBRIDGE_URL=ws://localhost:9090
      - NODE_ENV=production

  # openclaw_proxy - Backend API for OpenClaw chat integration
  openclaw_proxy:
    build:
      context: ../../web_interface/backend
      dockerfile: ../../docker/dev/openclaw_proxy.dev.Dockerfile
    container_name: openclaw_proxy_vps
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ../../web_interface/backend:/app
    environment:
      - OPENCLAW_GATEWAY_URL=ws://localhost:6277
      - PORT=8000

# Notes:
# - OpenClaw gateway runs as systemd service (not Docker)
# - All services use host networking for simplicity
# - Ports exposed: 3000 (frontend), 9090 (rosbridge), 8000 (openclaw_proxy)
# - srv01 drone_core publishes telemetry â†’ rosbridge (port 9090)
# - Frontend subscribes to topics via rosbridge WebSocket
